name: Test concourse-ci-machine charm

on:
  push:
    branches:
      - main

jobs:
  test-charm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable
      - name: Wait for LXD
        run: |
          while ! ip link show lxdbr0; do
            echo "Waiting for lxdbr0..."
            sleep 10
          done
      - name: Install Juju
        run: |
          sudo snap install juju
          sudo snap install juju-wait --classic
      - name: Bootstrap Juju
        run: sudo juju bootstrap localhost --config test-mode=true

      - name: Deploy charm
        run: sudo juju deploy concourse-ci-machine --channel edge --config deployment-mode=all

      - name: Wait for model to settle
        run: sudo juju wait -m default --for=settled --timeout=15m
