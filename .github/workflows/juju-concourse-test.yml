name: Test concourse-ci-machine charm

on:
  push:
    branches:
      - main

jobs:
  test-charm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Install Juju
        run: |
          sudo snap install juju
          sudo snap install juju-wait --classic
      - name: Bootstrap Juju
        run: sudo juju bootstrap localhost --config test-mode=true
      - name: Add Juju Model
        run: sudo juju add-model concourse-ci

      - name: Deploy charms
        run: |
          sudo juju deploy concourse-ci-machine concourse-ci --channel edge --config deployment-mode=all
          sudo juju deploy postgresql --channel 16/stable
      - name: Relate charms
        run: sudo juju relate concourse-ci:postgresql postgresql:database

      - name: Wait for model to settle
        run: sudo juju-wait -m concourse-ci --for=settled --timeout=15m
